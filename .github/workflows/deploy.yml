name: Deploy to Production

on:
  # Trigger on tag creation (e.g., v1.0.0)
  push:
    tags:
      - 'v*'  # Matches tags like v1.0.0, v1.2.3, etc.
  
  # Trigger on release creation
  release:
    types: [published]
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy (e.g., v1.0.0)'
        required: false
        type: string

jobs:
  deploy:
    name: Deploy to Linode
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch tags for version information
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Display deployment info
        run: |
          echo "Deploying version: ${{ steps.get_version.outputs.version }}"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        timeout-minutes: 10
      
      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production
          # GitHub Secrets (encrypted, sensitive data)
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          # GitHub Variables (non-sensitive configuration)
          FROM_EMAIL: ${{ vars.FROM_EMAIL }}
          MAINTENANCE_MODE: ${{ vars.MAINTENANCE_MODE }}
      
      - name: Verify build output
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "Build failed: dist directory is empty or missing"
            exit 1
          fi
          if [ ! -f "dist/server/entry.mjs" ]; then
            echo "Build failed: dist/server/entry.mjs not found (SSR output expected)"
            exit 1
          fi
          if [ ! -d "dist/client" ]; then
            echo "Build failed: dist/client directory not found (SSR output expected)"
            exit 1
          fi
          echo "Build successful: $(du -sh dist | cut -f1) of files generated"
      
      - name: Backup current deployment
        run: |
          if [ -d "/var/www/bellatechnologies.in/dist" ]; then
            BACKUP_DIR="/var/www/bellatechnologies.in/backups/$(date +%Y%m%d-%H%M%S)"
            sudo mkdir -p "$BACKUP_DIR"
            sudo cp -r /var/www/bellatechnologies.in/dist "$BACKUP_DIR/"
            echo "Backup created at: $BACKUP_DIR"
          fi
        continue-on-error: true
      
      - name: Deploy to web directory
        run: |
          echo "Deploying files to production..."
          sudo rm -rf /var/www/bellatechnologies.in/dist
          sudo mkdir -p /var/www/bellatechnologies.in/dist
          sudo cp -r dist/* /var/www/bellatechnologies.in/dist/
          sudo chown -R www-data:www-data /var/www/bellatechnologies.in/dist
          sudo chmod -R 755 /var/www/bellatechnologies.in/dist
          echo "Files deployed successfully"
      
      - name: Deploy scripts directory
        run: |
          echo "Deploying scripts directory to production..."
          sudo mkdir -p /var/www/bellatechnologies.in/scripts
          sudo cp -r scripts/* /var/www/bellatechnologies.in/scripts/
          sudo chown -R www-data:www-data /var/www/bellatechnologies.in/scripts
          sudo chmod -R 755 /var/www/bellatechnologies.in/scripts
          # Ensure Python scripts are executable
          sudo find /var/www/bellatechnologies.in/scripts -name "*.py" -exec chmod +x {} \;
          echo "Scripts deployed successfully"
      
      - name: Create production environment file
        run: |
          echo "Creating production environment file..."
          sudo tee /var/www/bellatechnologies.in/.env.production > /dev/null <<EOF
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          FROM_EMAIL=${{ vars.FROM_EMAIL }}
          MAINTENANCE_MODE=${{ vars.MAINTENANCE_MODE }}
          HOST=127.0.0.1
          PORT=4321
          EOF
          sudo chown www-data:www-data /var/www/bellatechnologies.in/.env.production
          sudo chmod 600 /var/www/bellatechnologies.in/.env.production
          echo "Production environment file created"

      - name: Install production Node dependencies (SSR runtime)
        run: |
          echo "Installing production dependencies on server..."
          sudo cp package.json package-lock.json /var/www/bellatechnologies.in/
          sudo chown -R www-data:www-data /var/www/bellatechnologies.in
          sudo -u www-data mkdir -p /var/www/bellatechnologies.in/.npm-cache
          sudo -u www-data bash -lc 'cd /var/www/bellatechnologies.in && npm ci --omit=dev --cache /var/www/bellatechnologies.in/.npm-cache --no-audit --no-fund'
          echo "Production dependencies installed"

      - name: Install or update systemd service
        run: |
          echo "Installing/updating systemd service..."
          dump_service_diagnostics() {
            sudo systemctl status bellatechnologies.service --no-pager -l || true
            sudo journalctl -u bellatechnologies.service -n 200 --no-pager -o cat || true
          }
          if [ ! -f "/var/www/bellatechnologies.in/scripts/bellatechnologies.service" ]; then
            echo "Service unit not found in deployed scripts directory"
            exit 1
          fi
          sudo cp /var/www/bellatechnologies.in/scripts/bellatechnologies.service /etc/systemd/system/bellatechnologies.service
          sudo systemctl daemon-reload
          sudo systemctl enable bellatechnologies.service
          sudo systemctl restart bellatechnologies.service || { echo "Service restart failed"; dump_service_diagnostics; exit 1; }
          sudo systemctl is-active --quiet bellatechnologies.service || { echo "Service is not active after restart"; dump_service_diagnostics; exit 1; }
          echo "Systemd service is running"
      
      - name: Configure Nginx Maintenance Mode
        run: |
          echo "Configuring nginx based on maintenance mode..."
          if [ -f "/var/www/bellatechnologies.in/scripts/configure-nginx-maintenance.py" ]; then
            sudo python3 /var/www/bellatechnologies.in/scripts/configure-nginx-maintenance.py
          else
            echo "Warning: Maintenance configuration script not found, skipping nginx maintenance mode setup"
            echo "Reloading Nginx..."
            sudo nginx -t && sudo systemctl reload nginx
            echo "Nginx reloaded successfully"
          fi
      
      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          if [ ! -f "/var/www/bellatechnologies.in/dist/server/entry.mjs" ]; then
            echo "Deployment verification failed: server entry not found"
            exit 1
          fi
          if [ ! -d "/var/www/bellatechnologies.in/dist/client" ]; then
            echo "Deployment verification failed: client directory not found"
            exit 1
          fi
          sudo systemctl is-active --quiet bellatechnologies.service
          echo "Deployment verified: server + client present, service active"
          echo "Website should be live at: https://bellatechnologies.in"
      
      - name: Cleanup old backups
        run: |
          # Keep only last 5 deployment backups
          sudo find /var/www/bellatechnologies.in/backups -maxdepth 1 -type d -name "20*" | sort -r | tail -n +6 | sudo xargs rm -rf
          echo "Old deployment backups cleaned up"
          
          # Keep only last 5 nginx config backups
          sudo find /etc/nginx/sites-available -maxdepth 1 -type f -name "bellatechnologies.in.backup.*" | sort -r | tail -n +6 | sudo xargs rm -f
          echo "Old nginx config backups cleaned up"
        continue-on-error: true
