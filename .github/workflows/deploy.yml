name: Deploy to Production

on:
  # Trigger on tag creation (e.g., v1.0.0)
  push:
    tags:
      - 'v*'  # Matches tags like v1.0.0, v1.2.3, etc.
  
  # Trigger on release creation
  release:
    types: [published]
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy (e.g., v1.0.0)'
        required: false
        type: string

jobs:
  deploy:
    name: Deploy to Linode
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch tags for version information
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "version=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Display deployment info
        run: |
          echo "ðŸš€ Deploying version: ${{ steps.get_version.outputs.version }}"
          echo "ðŸ“¦ Repository: ${{ github.repository }}"
          echo "ðŸ”– Ref: ${{ github.ref }}"
          echo "ðŸ‘¤ Actor: ${{ github.actor }}"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        timeout-minutes: 10
      
      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production
          # GitHub Secrets (encrypted, sensitive data)
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          # GitHub Variables (non-sensitive configuration)
          FROM_EMAIL: ${{ vars.FROM_EMAIL }}
          MAINTENANCE_MODE: ${{ vars.MAINTENANCE_MODE }}
      
      - name: Verify build output
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "âŒ Build failed: dist directory is empty or missing"
            exit 1
          fi
          echo "âœ… Build successful: $(du -sh dist | cut -f1) of files generated"
      
      - name: Backup current deployment
        run: |
          if [ -d "/var/www/bellatechnologies.in/dist" ]; then
            BACKUP_DIR="/var/www/bellatechnologies.in/backups/$(date +%Y%m%d-%H%M%S)"
            sudo mkdir -p "$BACKUP_DIR"
            sudo cp -r /var/www/bellatechnologies.in/dist "$BACKUP_DIR/"
            echo "ðŸ“¦ Backup created at: $BACKUP_DIR"
          fi
        continue-on-error: true
      
      - name: Deploy to web directory
        run: |
          echo "ðŸ“¤ Deploying files to production..."
          sudo rm -rf /var/www/bellatechnologies.in/dist
          sudo mkdir -p /var/www/bellatechnologies.in/dist
          sudo cp -r dist/* /var/www/bellatechnologies.in/dist/
          sudo chown -R www-data:www-data /var/www/bellatechnologies.in/dist
          sudo chmod -R 755 /var/www/bellatechnologies.in/dist
          echo "âœ… Files deployed successfully"
      
      - name: Create production environment file
        run: |
          echo "ðŸ“ Creating production environment file..."
          sudo tee /var/www/bellatechnologies.in/.env.production > /dev/null <<EOF
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          FROM_EMAIL=${{ vars.FROM_EMAIL }}
          MAINTENANCE_MODE=${{ vars.MAINTENANCE_MODE }}
          EOF
          sudo chown www-data:www-data /var/www/bellatechnologies.in/.env.production
          sudo chmod 600 /var/www/bellatechnologies.in/.env.production
          echo "âœ… Production environment file created"
      
      - name: Configure Nginx Maintenance Mode
        run: |
          echo "ðŸ”§ Configuring nginx based on maintenance mode..."
          if [ -f "scripts/configure-nginx-maintenance.py" ]; then
            python3 scripts/configure-nginx-maintenance.py
          else
            echo "âš ï¸  Maintenance configuration script not found, skipping nginx maintenance mode setup"
            echo "ðŸ”„ Reloading Nginx..."
            sudo nginx -t && sudo systemctl reload nginx
            echo "âœ… Nginx reloaded successfully"
          fi
      
      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          if [ ! -f "/var/www/bellatechnologies.in/dist/index.html" ]; then
            echo "âŒ Deployment verification failed: index.html not found"
            exit 1
          fi
          echo "âœ… Deployment verified: index.html exists"
          echo "ðŸŒ Website should be live at: http://bellatechnologies.in"
      
      - name: Cleanup old backups
        run: |
          # Keep only last 5 backups
          sudo find /var/www/bellatechnologies.in/backups -maxdepth 1 -type d -name "20*" | sort -r | tail -n +6 | sudo xargs rm -rf
          echo "ðŸ§¹ Old backups cleaned up"
        continue-on-error: true
